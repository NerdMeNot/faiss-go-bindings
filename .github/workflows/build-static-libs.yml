name: Build Static Libraries

# Builds fully self-contained static FAISS libraries with all dependencies bundled.
# For Linux, this includes static OpenBLAS, eliminating runtime dependencies.
# For macOS, uses the system Accelerate framework (always available).
#
# Run this workflow to update the pre-built libraries in lib/

on:
  workflow_dispatch:
    inputs:
      faiss_version:
        description: 'FAISS version tag (e.g., v1.13.2) - should match VERSION file'
        required: true
        default: 'v1.13.2'
      build_fully_static:
        description: 'Build fully static libs (bundle OpenBLAS)'
        required: true
        default: 'true'
        type: boolean
      platforms:
        description: 'Platforms to build (comma-separated: linux-amd64,linux-arm64,darwin-amd64,darwin-arm64 or "all")'
        required: true
        default: 'all'

jobs:
  build-linux-amd64:
    if: contains(github.event.inputs.platforms, 'linux-amd64') || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            gfortran \
            libopenblas-dev \
            libomp-dev

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build-static-libs.sh
          if [ "${{ github.event.inputs.build_fully_static }}" = "true" ]; then
            # Build with OpenBLAS statically linked (no runtime deps)
            ./scripts/build-static-libs.sh
          else
            # Build with system dependencies
            ./scripts/build_static_lib.sh linux-amd64 ${{ github.event.inputs.faiss_version }}
          fi

      - name: Build FAISS Go extensions
        run: |
          cd c_api_ext
          chmod +x build.sh
          ./build.sh
          cp libfaiss_go_ext.a ../lib/linux_amd64/

      - name: Verify library
        run: |
          ls -lh lib/linux_amd64/
          file lib/linux_amd64/libfaiss.a

          # Check library size (with OpenBLAS should be 40MB+)
          SIZE=$(stat -c%s lib/linux_amd64/libfaiss.a)
          echo "Library size: $SIZE bytes"

          # Check if OpenBLAS symbols are defined (T) not undefined (U)
          echo "Checking for BLAS symbols..."
          if nm lib/linux_amd64/libfaiss.a 2>/dev/null | grep -q " T .*sgemm"; then
            echo "✓ OpenBLAS is statically linked (sgemm defined)"
          elif nm lib/linux_amd64/libfaiss.a 2>/dev/null | grep -q " U .*sgemm"; then
            echo "⚠ OpenBLAS NOT merged (sgemm undefined)"
          fi

          nm lib/linux_amd64/libfaiss.a 2>/dev/null | grep -E "gemm" | head -10 || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-linux-amd64
          path: lib/linux_amd64/
          retention-days: 90

  build-linux-arm64:
    if: contains(github.event.inputs.platforms, 'linux-arm64') || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Docker for ARM64
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:24.04 \
            bash -c "
              apt-get update && \
              apt-get install -y build-essential cmake git gfortran libgomp1 curl && \
              chmod +x scripts/build-static-libs.sh && \
              if [ '${{ github.event.inputs.build_fully_static }}' = 'true' ]; then
                ./scripts/build-static-libs.sh
              else
                apt-get install -y libopenblas-dev libomp-dev && \
                chmod +x scripts/build_static_lib.sh && \
                ./scripts/build_static_lib.sh linux-arm64 ${{ github.event.inputs.faiss_version }}
              fi && \
              cd c_api_ext && \
              chmod +x build.sh && \
              ./build.sh && \
              cp libfaiss_go_ext.a ../lib/linux_arm64/
            "

      - name: Verify library
        run: |
          ls -lh lib/linux_arm64/
          file lib/linux_arm64/libfaiss.a || true
          # Check if OpenBLAS symbols are defined (not undefined)
          echo "Checking for BLAS symbols..."
          nm lib/linux_arm64/libfaiss.a 2>/dev/null | grep -E "sgemm_|dgemm_" | head -5 || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-linux-arm64
          path: lib/linux_arm64/
          retention-days: 90

  build-darwin-amd64:
    if: contains(github.event.inputs.platforms, 'darwin-amd64') || github.event.inputs.platforms == 'all'
    runs-on: macos-15-intel  # Intel Mac

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake openblas libomp

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh darwin-amd64 ${{ github.event.inputs.faiss_version }}

      - name: Build FAISS Go extensions
        run: |
          cd c_api_ext
          chmod +x build.sh
          ./build.sh
          cp libfaiss_go_ext.a ../lib/darwin_amd64/

      - name: Verify library
        run: |
          ls -lh lib/darwin_amd64/
          file lib/darwin_amd64/libfaiss.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-darwin-amd64
          path: lib/darwin_amd64/
          retention-days: 90

  build-darwin-arm64:
    if: contains(github.event.inputs.platforms, 'darwin-arm64') || github.event.inputs.platforms == 'all'
    runs-on: macos-14  # M1 Mac

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake openblas libomp

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh darwin-arm64 ${{ github.event.inputs.faiss_version }}

      - name: Build FAISS Go extensions
        run: |
          cd c_api_ext
          chmod +x build.sh
          ./build.sh
          cp libfaiss_go_ext.a ../lib/darwin_arm64/

      - name: Verify library
        run: |
          ls -lh lib/darwin_arm64/
          file lib/darwin_arm64/libfaiss.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-darwin-arm64
          path: lib/darwin_arm64/
          retention-days: 90

  # Collect and upload combined artifacts
  collect-artifacts:
    needs: [build-linux-amd64, build-linux-arm64, build-darwin-amd64, build-darwin-arm64]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: libs-artifacts

      - name: Show downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lR libs-artifacts/

      - name: Create combined artifact with all platforms
        run: |
          mkdir -p combined-static-libs

          # Copy all platform artifacts into one directory
          for platform in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64; do
            if [ -d "libs-artifacts/faiss-static-$platform" ]; then
              echo "Adding $platform..."
              cp -r "libs-artifacts/faiss-static-$platform" "combined-static-libs/"
            fi
          done

          # Show what we have
          echo "=== Combined artifact contents ==="
          tree -L 2 combined-static-libs/ || ls -lR combined-static-libs/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-static-libraries
          path: combined-static-libs/
          retention-days: 90

      - name: Create installation instructions
        run: |
          cat > combined-static-libs/INSTALL.md << 'EOF'
          # Manual Installation Instructions

          Download the "all-static-libraries" artifact from GitHub Actions and extract it.

          ## File Mapping

          For each platform, copy the following files to the lib/ directory:

          ### Linux AMD64
          ```bash
          cp faiss-static-linux-amd64/libfaiss.a lib/linux_amd64/
          cp faiss-static-linux-amd64/libfaiss_c.a lib/linux_amd64/
          cp faiss-static-linux-amd64/libfaiss_go_ext.a lib/linux_amd64/
          ```

          ### Linux ARM64
          ```bash
          cp faiss-static-linux-arm64/libfaiss.a lib/linux_arm64/
          cp faiss-static-linux-arm64/libfaiss_c.a lib/linux_arm64/
          cp faiss-static-linux-arm64/libfaiss_go_ext.a lib/linux_arm64/
          ```

          ### Darwin AMD64 (Intel Mac)
          ```bash
          cp faiss-static-darwin-amd64/libfaiss.a lib/darwin_amd64/
          cp faiss-static-darwin-amd64/libfaiss_c.a lib/darwin_amd64/
          cp faiss-static-darwin-amd64/libfaiss_go_ext.a lib/darwin_amd64/
          ```

          ### Darwin ARM64 (Apple Silicon)
          ```bash
          cp faiss-static-darwin-arm64/libfaiss.a lib/darwin_arm64/
          cp faiss-static-darwin-arm64/libfaiss_c.a lib/darwin_arm64/
          cp faiss-static-darwin-arm64/libfaiss_go_ext.a lib/darwin_arm64/
          ```

          ## Test the Build

          ```bash
          go build -v ./...
          ```
          EOF

          echo "Created installation instructions"
