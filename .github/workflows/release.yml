name: Release

on:
  workflow_dispatch:
    inputs:
      patch:
        description: 'Patch number for binding fixes (leave empty for initial FAISS version release)'
        required: false
        default: ''

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get FAISS version
      id: version
      run: |
        FAISS_VERSION=$(cat VERSION)
        echo "faiss_version=$FAISS_VERSION" >> $GITHUB_OUTPUT

        PATCH="${{ github.event.inputs.patch }}"
        if [ -n "$PATCH" ]; then
          TAG="v${FAISS_VERSION}-${PATCH}"
        else
          TAG="v${FAISS_VERSION}"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Check if tag exists
      id: check_tag
      run: |
        TAG="${{ steps.version.outputs.tag }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "::error::Tag $TAG already exists"
          exit 1
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Verify build
      run: go build -v ./...

    - name: Run tests
      run: go test -v ./...

    - name: Create Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ steps.version.outputs.tag }}"
        FAISS_VERSION="${{ steps.version.outputs.faiss_version }}"
        PATCH="${{ github.event.inputs.patch }}"

        if [ -n "$PATCH" ]; then
          TITLE="Release $TAG (FAISS $FAISS_VERSION, patch $PATCH)"
          NOTES="Binding patch release for FAISS $FAISS_VERSION.

See [FAISS $FAISS_VERSION release](https://github.com/facebookresearch/faiss/releases/tag/v$FAISS_VERSION) for upstream changes."
        else
          TITLE="Release $TAG (FAISS $FAISS_VERSION)"
          NOTES="Go bindings for FAISS $FAISS_VERSION.

## What's Included

- Pre-built static libraries for:
  - Linux (amd64, arm64)
  - macOS (amd64, arm64)
  - Windows (amd64)

## Usage

\`\`\`go
import _ \"github.com/NerdMeNot/faiss-go-bindings\"
\`\`\`

See [README](https://github.com/NerdMeNot/faiss-go-bindings#readme) for full documentation.

## FAISS Release

See [FAISS $FAISS_VERSION release](https://github.com/facebookresearch/faiss/releases/tag/v$FAISS_VERSION) for upstream changes."
        fi

        gh release create "$TAG" \
          --title "$TITLE" \
          --notes "$NOTES"

    - name: Summary
      run: |
        TAG="${{ steps.version.outputs.tag }}"
        echo "## Release Created" >> $GITHUB_STEP_SUMMARY
        echo "Tag: $TAG" >> $GITHUB_STEP_SUMMARY
        echo "URL: https://github.com/${{ github.repository }}/releases/tag/$TAG" >> $GITHUB_STEP_SUMMARY
