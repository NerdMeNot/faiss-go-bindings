name: Check FAISS Releases

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9:00 UTC
  workflow_dispatch:

jobs:
  check-release:
    name: Check for New FAISS Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get current FAISS version
      id: current
      run: |
        # Extract version from README or use a VERSION file
        if [ -f VERSION ]; then
          CURRENT_VERSION=$(cat VERSION)
        else
          # Default to version mentioned in README
          CURRENT_VERSION="1.8.0"
        fi
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current FAISS version: $CURRENT_VERSION"

    - name: Get latest FAISS release
      id: latest
      run: |
        LATEST=$(curl -s https://api.github.com/repos/facebookresearch/faiss/releases/latest | jq -r '.tag_name')
        LATEST_VERSION=${LATEST#v}
        echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "tag=$LATEST" >> $GITHUB_OUTPUT
        echo "Latest FAISS release: $LATEST_VERSION"

    - name: Compare versions
      id: compare
      run: |
        CURRENT="${{ steps.current.outputs.version }}"
        LATEST="${{ steps.latest.outputs.version }}"
        echo "Comparing: current=$CURRENT vs latest=$LATEST"
        if [ "$CURRENT" = "$LATEST" ]; then
          echo "up_to_date=true" >> $GITHUB_OUTPUT
          echo "Already on latest version"
        else
          echo "up_to_date=false" >> $GITHUB_OUTPUT
          echo "New version available!"
        fi

    - name: Check for existing issue
      id: existing
      if: steps.compare.outputs.up_to_date == 'false'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        LATEST="${{ steps.latest.outputs.version }}"
        EXISTING=$(gh issue list --state open --search "FAISS $LATEST" --json number --jq 'length')
        if [ "$EXISTING" -gt 0 ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create issue for new release
      if: steps.compare.outputs.up_to_date == 'false' && steps.existing.outputs.exists == 'false'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CURRENT_VERSION: ${{ steps.current.outputs.version }}
        LATEST_VERSION: ${{ steps.latest.outputs.version }}
        LATEST_TAG: ${{ steps.latest.outputs.tag }}
      run: |
        gh issue create \
          --title "Update to FAISS $LATEST_VERSION" \
          --label "enhancement" \
          --body "## New FAISS Release Available

**Current:** $CURRENT_VERSION
**Latest:** $LATEST_VERSION

**Release:** https://github.com/facebookresearch/faiss/releases/tag/$LATEST_TAG

### Checklist

- [ ] Review FAISS changelog for C API changes
- [ ] Run build-static-libs workflow for all platforms
- [ ] Update VERSION file
- [ ] Update README version info
- [ ] Test bindings compile on all platforms
- [ ] Create release tag

---
*Auto-generated by FAISS release checker*"

    - name: Summary
      run: |
        echo "## FAISS Version Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Current:** ${{ steps.current.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest:** ${{ steps.latest.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.compare.outputs.up_to_date }}" = "true" ]; then
          echo "**Status:** Up to date" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** New version available!" >> $GITHUB_STEP_SUMMARY
        fi
